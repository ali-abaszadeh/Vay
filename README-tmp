### Structure
# ./certificates
#   | --- ca/
#   |     | --- {ENV}ROOTCA.key
#   |     | --- {ENV}ROOTCA.pem
#   | --- certificates
#         | --- {DOMAINs}.crt

### ROOT CA
ENV=test
openssl genrsa -des3 -out ${ENV}ROOTCA.key 2048
openssl req -x509 -new -nodes -subj "/C=GR/CN=Vay ${ENV} Root CA/O=Vay/OU=DevOps" -key ${ENV}ROOTCA.key -sha256 -days 1825 -out ${ENV}ROOTCA.pem
openssl x509 -in ${ENV}ROOTCA.pem -inform PEM -out ${ENV}ROOTCA.crt

ublBcr9LM95j0GBhAQU5vQ2IIr3OPseX

### Install ROOT CA (Ubuntu)
sudo mkdir /usr/share/ca-certificates/extra
sudo cp ${ENV}/ca/${ENV}ROOTCA.crt /usr/share/ca-certificates/extra/
sudo echo "extra/${ENV}ROOTCA.crt" >> /etc/ca-certificates.conf
sudo update-ca-certificates

# In the container cases after this step you have to restart docker service
systemctl restart docker

#################################################################################


### DOMAIN CERT
DOMAIN=let.me.play
openssl genrsa -out ${DOMAIN}.key 2048
openssl req -subj "/C=GR/CN=${DOMAIN}/O=Vay/OU=DevOps" -new -key ${DOMAIN}.key -out ${DOMAIN}.csr
cat <<EOF > ${DOMAIN}.ext
authorityKeyIdentifier=keyid,issuer
basicConstraints=CA:FALSE
keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
subjectAltName = @alt_names

[alt_names]
DNS.1 = ${DOMAIN}
EOF

openssl x509 -req -in ${DOMAIN}.csr -CA ca/${ENV}ROOTCA.pem -CAkey ca/${ENV}ROOTCA.key -CAcreateserial \
-out ${DOMAIN}.crt -days 825 -sha256 -extfile ${DOMAIN}.ext

### DOMAIN Cert chain
cat ${DOMAIN}.key ${DOMAIN}.crt ca/${ENV}ROOTCA.crt > ${DOMAIN}.pem


###################################################################################################################
#    check SSL Match keys

# You can check whether a certificate matches a private key, or a CSR matches a certificate on your own computer by using the OpenSSL commands below:

openssl pkey -in privateKey.key -pubout -outform pem | sha256sum
openssl x509 -in certificate.crt -pubkey -noout -outform pem | sha256sum
openssl req -in CSR.csr -pubkey -noout -outform pem | sha256sum


#################################

# Git checkout to finding commit

git clone git_repository_address
git log
git checkout 285a495d

# Change at commit 285a495d
git reset --hard 285a495d

##################################


